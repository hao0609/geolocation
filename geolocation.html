<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocation API Test</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
            <h1>Geolocation API Test</h1>

            <h2>緯度：{{lat}}</h2> 

            <h2>經度：{{lng}}</h2> 

            <h2>精準度：{{accuracy}}</h2> 

            <!-- <h2>{{check_result}}</h2> -->

            <h2>捷運站經緯度</h2>

            請選擇捷運路線:  <input list="Lines" @change="selected_line" v-model="user_selected_line"> <br><br>

            <datalist id="Lines">
                <option value="R"> 淡水信義線
                <option value="G"> 松山新店線
                <option value="BL"> 板南線
                <option value="O"> 中和新爐線
                <option value="BR"> 文湖線
            </datalist>


            請選擇捷運站:  <input list="Stations" > <br><br>

            <datalist id="Stations">
                <!-- <option value="永寧">  -->
            </datalist>


            
            緯度：<input type="text" v-model="targetLat"><br>
            經度：<input type="text" v-model="targetLng"><br>



            <h2>與捷運站距離：{{distanc}} 公尺</h2>

            <!-- 台北捷運各路線車站資料 API URL -->
            <!-- https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/StationOfRoute/TRTC?%24filter=contains%28LineID%2C%27BL%27%29&%24top=1&%24format=JSON -->
            <!-- URL 原文 -->
            <!-- https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/StationOfRoute/TRTC?$filter=contains(LineID,'BL')&$top=1&$format=JSON -->
            
    </div>
</body>
<script>
    // 判斷瀏覽器是否支援 geolocation API 
    if ("geolocation" in navigator) {
         console.log(`OK! geolocation API is Support!`);

         Vue.createApp({
            

            data(){     // 變數放這裡
                return {
                    options:{
                        enableHighAccuracy: true, 
                        timeout: 60000,          
                        maximumAge: 60000       
                    },
                    lat: 0,
                    lng: 0,
                    accuracy:0,
                    targetLat: 25.00221178,   //判斷目標經緯度
                    targetLng: 121.4964906,
                    radius: 50,             //距離範圍限制半徑 50 公尺
                    check_result: false, 
                    distanc: 0,
                    user_selected_line:'',
                }
            },

            methods: {  // 函數(方法)大部分放這裡
                
                success_getlocation(pos){                    
                    this.lat = pos.coords.latitude
                    this.lng = pos.coords.longitude
                    this.accuracy = pos.coords.accuracy
                    console.log(this.lat)
                    console.log(this.lng)
                    console.log(this.accuracy);   
                    console.log(this.getDistanceFromLatLon(this.lat,this.lng,this.targetLat,this.targetLng));                    
                    this.distanc = this.getDistanceFromLatLon(this.lat,this.lng,this.targetLat,this.targetLng)
                 },
                 error_getlocation(){
                    console.log("位置定位失敗");            
                },
                 getDistanceFromLatLon(lat1, lon1, lat2, lon2) {
                    const R = 6371000; // 地球半徑 (公尺)
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLon = (lon2 - lon1) * Math.PI / 180;
                    const a = 
                        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon / 2) * Math.sin(dLon / 2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    
                    return  parseInt(R * c); // 距離（公尺）
                },

                selected_line(e){
                    console.log(e.target.value);
                    this.user_selected_line = e.target.value;
                    this.show_stations(this.user_selected_line);

                },

                show_stations(station){
                    let url = `https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/StationOfRoute/TRTC?$filter=LineID eq '${station}'&$top=1&$format=JSON`;
                    console.log(url);
                    
                    setTimeout(() => {

                        let result =  fetch(url, {
                    method: 'GET',})
                    
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json(); // 獲取並解析 JSON
                    })
                    .then(result => {
                        const stationData = result[0].Stations
                        console.log(stationData); 
                        stationData.forEach(element => {
                            console.log(element.StationName.Zh_tw);
                            document.querySelector('#Stations').innerHTML += `<option value="${element.StationName.Zh_tw}">${element.StationName.Zh_tw}</option>`
                        });

                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
                        
                    }, 5000);
                    
                    
                }


            },
            computed: { // 函數(方法)也可以放這裡，但是放在這裡的函數(方法)不用傳參數，一定要有傳回值

            },
            mounted() {
                
                // navigator.geolocation.getCurrentPosition(
                //     (pos) => this.success_getlocation(pos),  // 使用箭頭函數保證 this 正確
                //     () => this.error_getlocation(),         // 使用箭頭函數     
                //     this.options
                // )
                navigator.geolocation.watchPosition(
                    (pos) => this.success_getlocation(pos),
                    () => this.error_getlocation(),
                    this.options
                )

            },

        }).mount('#app')
       
         
    } else 
    {
     console.log(`Not Support!`);
    }




</script>
</html>